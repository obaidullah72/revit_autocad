{% extends "automation/base.html" %}

{% block title %}New Run · Lighting Automation Studio{% endblock %}
{% block header_title %}{% endblock %}

{% block content %}
    <section class="dashboard-grid">
        <section class="card card-main upload-card">
            {% if error %}
                <div class="alert alert-error">{{ error }}</div>
            {% endif %}

            <form method="post" enctype="multipart/form-data" class="form-two-col" id="automation-form">
                {% csrf_token %}

                <div class="form-stack">
                    <div class="field">
                        <label for="name">Plan name</label>
                        <input id="name" name="name" type="text" placeholder="e.g. Residential Tower · Level 03">
                    </div>

                    <div class="field">
                        <label for="file">Drawing file</label>
                        <input id="file" name="file" type="file" accept=".dxf,.dwg" required>
                        <p class="field-help">
                            DXF is preferred. DWG will only work if a converter is configured on the server.
                        </p>
                    </div>
                </div>

                <section class="rules-panel">
                    <div class="field-group">
                        <div class="field-group-title">Automation rules</div>
                        <div class="field-row">
                            <label for="lights_per_room">Lights per room</label>
                            <input id="lights_per_room" name="lights_per_room" type="number" min="1"
                                   value="{{ default_lights_per_room|default:1 }}">
                        </div>
                        <div class="field-row">
                            <label for="switches_per_door">Switches per door</label>
                            <input id="switches_per_door" name="switches_per_door" type="number" min="1"
                                   value="{{ default_switches_per_door|default:1 }}">
                        </div>
                        <div class="field-row">
                            <label for="sockets_enabled">
                                <input id="sockets_enabled" name="sockets_enabled" type="checkbox" checked>
                                Enable sockets/outlets
                            </label>
                        </div>
                        <div class="field-row">
                            <label for="socket_spacing">Socket spacing (mm)</label>
                            <input id="socket_spacing" name="socket_spacing" type="number" min="500" step="100"
                                   value="3000" placeholder="3000 (default)">
                            <p class="field-help">Standard spacing: 3000mm. Leave empty for default.</p>
                        </div>
                        <div class="field-row">
                            <label for="use_legacy_mode">
                                <input id="use_legacy_mode" name="use_legacy_mode" type="checkbox">
                                Use legacy placement mode
                            </label>
                            <p class="field-help">Use simple placement logic (for backward compatibility).</p>
                        </div>
                    </div>
                </section>

                <div class="form-stack">
                    <button type="submit" class="btn-primary btn-large" id="run-button">
                        Run automation
                    </button>
                </div>
            </form>
            <div id="automation-loader" class="automation-loader" style="display: none;">
                <div class="automation-loader-backdrop"></div>
                <div class="automation-loader-panel">
                    <div class="automation-spinner"></div>
                    <p>Running automation… this may take a few seconds.</p>
                </div>
            </div>
        </section>

        <section class="card card-side info-card">
            <h3 class="side-title">Before you upload</h3>
            <p class="side-note">
                Use DXF or DWG plans with clearly defined rooms and doors. The automation will place
                ceiling lights in each detected room and switches near doors.
            </p>
            <ul class="checklist">
                <li>
                    <span class="check-label">ROOM geometry</span>
                    <span class="check-text">Closed polylines outlining each room or space.</span>
                </li>
                <li>
                    <span class="check-label">Doors</span>
                    <span class="check-text">Insert blocks or door symbols used as anchors for switches.</span>
                </li>
                <li>
                    <span class="check-label">Units</span>
                    <span class="check-text">Plans should be in millimetres for sensible spacing.</span>
                </li>
            </ul>
        </section>
    </section>

    {% if recent_plans %}
        <section class="card card-table">
            <header class="card-header">
                <h3 class="card-title">Recent runs</h3>
                <p class="card-subtitle">
                    Re‑open a previous upload to view its status and download the processed DXF.
                </p>
            </header>

            <table class="table">
                <thead>
                <tr>
                    <th>Plan</th>
                    <th>Created</th>
                    <th>Status</th>
                    <th></th>
                </tr>
                </thead>
                <tbody>
                {% for p in recent_plans %}
                    <tr>
                        <td>{{ p.name|default:"Plan " | add:p.id }}</td>
                        <td>{{ p.created_at|date:"Y-m-d H:i" }}</td>
                        <td>
                            {% if p.processed_output %}
                                <span class="pill pill-{{ p.processed_output.status|lower }}">
                                    {{ p.processed_output.status }}
                                </span>
                            {% else %}
                                <span class="pill pill-pending">PENDING</span>
                            {% endif %}
                        </td>
                        <td class="table-actions">
                            <a href="{% url 'automation:plan_detail' p.id %}" class="btn-ghost">Open</a>
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </section>
    {% endif %}
{% endblock %}

{% block extra_js %}
<script>
    (function () {
        const form = document.getElementById("automation-form");
        const loader = document.getElementById("automation-loader");
        const runButton = document.getElementById("run-button");
        if (!form || !loader || !runButton) return;

        form.addEventListener("submit", function () {
            loader.style.display = "block";
            runButton.disabled = true;
        });
    })();
</script>
{% endblock %}


